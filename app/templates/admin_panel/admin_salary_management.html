{% extends "Admin-base.html" %}

{% block title %}Salary Management - UEBS{% endblock %}

{% block content %}
<!-- Top Navbar -->
<div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 sm:mb-8 space-y-4 sm:space-y-0">
  <div class="mt-12 md:mt-0">
    <h2 class="text-2xl sm:text-3xl lg:text-4xl font-bold text-white animate__animated animate__fadeInLeft bg-gradient-to-r from-white to-gray-300 bg-clip-text text-transparent">Salary Management</h2>
    <p class="text-white/70 mt-1 text-sm sm:text-base">Manage staff salaries and payment details</p>
  </div>
  <div class="flex items-center space-x-2 sm:space-x-4 w-full sm:w-auto">
    <div class="hidden md:block relative flex-1 max-w-md">
      <input type="text" id="searchStaffSalary" placeholder="Search staff..." class="w-full glass-card text-white placeholder-white/50 px-4 py-2 rounded-xl focus:outline-none focus:ring-2 focus:ring-purple-400 search-input">
      <button class="absolute right-3 top-2 text-white/70 hover:text-white">
        <i class="fas fa-search"></i>
      </button>
    </div>
    <button class="glass-card p-2 sm:p-3 rounded-xl text-white hover:bg-white/20 transition-all relative md:hidden">
      <i class="fas fa-search text-sm sm:text-base"></i>
    </button>
  </div>
</div>

<!-- Mobile search bar -->
<div class="md:hidden mb-4">
  <div class="relative">
    <input type="text" id="searchStaffSalaryMobile" placeholder="Search staff..." class="w-full glass-card text-white placeholder-white/50 px-4 py-2 rounded-xl focus:outline-none focus:ring-2 focus:ring-purple-400 search-input">
    <button class="absolute right-3 top-2 text-white/70 hover:text-white">
      <i class="fas fa-search"></i>
    </button>
  </div>
</div>

<!-- Filters -->
<div class="glass-card p-4 mb-6 rounded-2xl animate__animated animate__fadeInUp">
  <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
    <div>
      <label class="block text-white/80 mb-2">Role</label>
      <select id="filterRoleSalary" class="w-full glass-card text-white placeholder-white/50 px-4 py-2 rounded-xl focus:outline-none focus:ring-2 focus:ring-purple-400">
        <option value="">All Roles</option>
        <option value="Teacher">Teacher</option>
        <option value="Admin">Admin</option>
        <option value="Accountant">Accountant</option>
        <option value="Support">Support</option>
      </select>
    </div>
    <div>
      <label class="block text-white/80 mb-2">Month</label>
      <input type="month" id="salaryMonth" class="w-full glass-card text-white placeholder-white/50 px-4 py-2 rounded-xl focus:outline-none focus:ring-2 focus:ring-purple-400" value="2025-08">
    </div>
    <div class="flex items-end">
      <button id="refreshSalary" class="liquid-btn text-white px-6 py-3 rounded-xl font-semibold transition-all hover:scale-105 w-full">
        <i class="fas fa-sync-alt mr-2"></i> Refresh
      </button>
    </div>
  </div>
</div>

<!-- Current Month Salary Table -->
<div class="glass-card p-6 lg:p-8 rounded-2xl animate__animated animate__fadeInUp mb-6">
  <h3 class="text-xl sm:text-2xl font-semibold text-white mb-6 flex items-center">
    <i class="fas fa-money-bill-wave text-green-400 mr-3"></i> Current Month Salary
  </h3>
  <div class="overflow-x-auto">
    <table class="w-full text-white/80" id="salaryTable">
      <thead>
        <tr class="border-b border-white/20">
          <th class="text-left py-3 px-4">Name</th>
          <th class="text-left py-3 px-4">Role</th>
          <th class="text-left py-3 px-4">Base Salary</th>
          <th class="text-left py-3 px-4">Present Days</th>
          <th class="text-left py-3 px-4">Total Days</th>
          <th class="text-left py-3 px-4">Allowances</th>
          <th class="text-left py-3 px-4">Deductions</th>
          <th class="text-left py-3 px-4">Advance</th>
          <th class="text-left py-3 px-4">Loan</th>
          <th class="text-left py-3 px-4">Previous Pending</th>
          <th class="text-left py-3 px-4">Net Salary</th>
          <th class="text-left py-3 px-4">Status</th>
          <th class="text-left py-3 px-4">Action</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<!-- Salary History Table -->
<div class="glass-card p-6 lg:p-8 rounded-2xl animate__animated animate__fadeInUp">
  <h3 class="text-xl sm:text-2xl font-semibold text-white mb-6 flex items-center">
    <i class="fas fa-history text-purple-400 mr-3"></i> Salary History (All Months)
  </h3>
  <div class="overflow-x-auto">
    <table class="w-full text-white/80" id="historyTable">
      <thead>
        <tr class="border-b border-white/20">
          <th class="text-left py-3 px-4">Name</th>
          <th class="text-left py-3 px-4">Role</th>
          <th class="text-left py-3 px-4">Month</th>
          <th class="text-left py-3 px-4">Net Salary</th>
          <th class="text-left py-3 px-4">Status</th>
          <th class="text-left py-3 px-4">Payment Date</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<!-- Confirmation Modal -->
<div class="modal fixed inset-0 bg-black/50 z-50 hidden justify-center items-center" id="confirmModal">
  <div class="glass-card p-6 lg:p-8 rounded-2xl w-full max-w-md">
    <div class="flex justify-between items-center mb-6">
      <h3 class="text-xl sm:text-2xl font-semibold text-white" id="modalTitle">Confirm Action</h3>
      <button id="closeModal" class="text-white/70 hover:text-white text-2xl">&times;</button>
    </div>
    <p class="text-white/80 mb-6" id="modalMessage">Are you sure you want to mark this salary as paid?</p>
    <div class="flex justify-end space-x-4">
      <button id="confirmAction" class="liquid-btn text-white px-6 py-3 rounded-xl font-semibold transition-all hover:scale-105">
        Confirm
      </button>
      <button id="cancelAction" class="glass-card text-white px-6 py-3 rounded-xl font-semibold transition-all hover:bg-white/20">
        Cancel
      </button>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/10.9.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.9.0/firebase-database-compat.js"></script>
<!-- jsPDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script>
// Initialize Firebase
const firebaseConfig = {
  apiKey: "AIzaSyC7cG8KemxvH2VveDO6DnIkYUpIl2exesU",
  authDomain: "uebs-school.firebaseapp.com",
  projectId: "uebs-school",
  storageBucket: "uebs-school.firebasestorage.app",
  messagingSenderId: "740325293639",
  appId: "1:740325293639:web:9c505c9a48dd8ccc55fb62",
  measurementId: "G-T7YEBMNHBH"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();

let staffData = {};
let salaryData = {};
let currentStaffId = '';
let currentMonthKey = '';

// Fetch staff list
db.ref('staff').on('value', snap => {
  staffData = snap.val() || {};
  loadSalary();
  loadHistory();
});

// Load salary for selected month
async function loadSalary() {
  const monthValue = document.getElementById('salaryMonth').value;
  const [year, month] = monthValue.split('-');
  const monthKey = `${year}-${month}`;
  currentMonthKey = monthKey;
  salaryData = {};

  let fetchPromises = [];
  Object.keys(staffData).forEach(staffId => {
    const totalDaysInMonth = new Date(year, parseInt(month), 0).getDate();
    let presentDays = 0;
    for (let d = 1; d <= totalDaysInMonth; d++) {
      let dateStr = `${year}-${month.padStart(2, '0')}-${String(d).padStart(2, '0')}`;
      fetchPromises.push(
        db.ref(`staffAttendance/${dateStr}/${staffId}`).once('value').then(snap => {
          const status = snap.val()?.status;
          if (status === "Present") presentDays++;
        })
      );
    }
    fetchPromises.push(
      db.ref(`staffSalaries/${staffId}`).once('value').then(snap => {
        const allSalaries = snap.val() || {};
        let pending = 0;
        Object.keys(allSalaries).forEach(m => {
          if (m < monthKey && allSalaries[m].paymentStatus === 'Unpaid') {
            pending += allSalaries[m].netSalary || 0;
          }
        });
        const existing = allSalaries[monthKey] || {};
        const s = staffData[staffId];
        const baseSalary = s.salary || 0;
        const allowances = existing.allowances || 0;
        const deductions = existing.deductions || 0;
        const advance = existing.advance || 0;
        const loan = existing.loan || 0;
        const present = existing.presentDays || presentDays;
        const total = totalDaysInMonth;
        const netSalary = Math.round((baseSalary / total) * present + allowances - deductions - advance - loan);
        salaryData[staffId] = {
          baseSalary,
          allowances,
          deductions,
          advance,
          loan,
          presentDays: present,
          totalDays: total,
          netSalary,
          pending,
          paymentStatus: existing.paymentStatus || "Unpaid",
          paymentDate: existing.paymentDate || "",
          transactionId: existing.transactionId || ""
        };
      })
    );
  });

  await Promise.all(fetchPromises);
  populateSalaryTable();
}

// Populate salary table
function populateSalaryTable() {
  const tbody = document.querySelector('#salaryTable tbody');
  tbody.innerHTML = '';
  const roleFilter = document.getElementById('filterRoleSalary').value;
  const search = document.getElementById('searchStaffSalary').value.toLowerCase() ||
                 document.getElementById('searchStaffSalaryMobile').value.toLowerCase();

  Object.keys(salaryData).forEach(staffId => {
    const s = staffData[staffId];
    if (!s) return;
    if (roleFilter && s.role !== roleFilter) return;
    if (search && !s.fullName.toLowerCase().includes(search)) return;

    const sal = salaryData[staffId];
    const tr = document.createElement('tr');
    tr.className = 'border-b border-white/10 hover:bg-white/5';
    tr.innerHTML = `
      <td class="py-3 px-4">
        <div class="font-medium text-white">${s.fullName}</div>
        <div class="text-sm text-white/60">${s.email}</div>
      </td>
      <td class="py-3 px-4">
        <span class="px-2 py-1 rounded-full text-xs ${
          s.role === 'Teacher' ? 'bg-blue-500/20 text-blue-400' :
          s.role === 'Admin' ? 'bg-purple-500/20 text-purple-400' :
          s.role === 'Accountant' ? 'bg-green-500/20 text-green-400' :
          'bg-yellow-500/20 text-yellow-400'
        }">${s.role}</span>
      </td>
      <td class="py-3 px-4">
        <input type="number" value="${sal.baseSalary}" onchange="updateSalaryField('${staffId}', 'baseSalary', this.value)" class="w-full glass-card text-white placeholder-white/50 px-2 py-1 rounded-xl focus:outline-none focus:ring-2 focus:ring-purple-400">
      </td>
      <td class="py-3 px-4">${sal.presentDays}</td>
      <td class="py-3 px-4">${sal.totalDays}</td>
      <td class="py-3 px-4">
        <input type="number" value="${sal.allowances}" onchange="updateSalaryField('${staffId}', 'allowances', this.value)" class="w-full glass-card text-white placeholder-white/50 px-2 py-1 rounded-xl focus:outline-none focus:ring-2 focus:ring-purple-400">
      </td>
      <td class="py-3 px-4">
        <input type="number" value="${sal.deductions}" onchange="updateSalaryField('${staffId}', 'deductions', this.value)" class="w-full glass-card text-white placeholder-white/50 px-2 py-1 rounded-xl focus:outline-none focus:ring-2 focus:ring-purple-400">
      </td>
      <td class="py-3 px-4">
        <input type="number" value="${sal.advance}" onchange="updateSalaryField('${staffId}', 'advance', this.value)" class="w-full glass-card text-white placeholder-white/50 px-2 py-1 rounded-xl focus:outline-none focus:ring-2 focus:ring-purple-400">
      </td>
      <td class="py-3 px-4">
        <input type="number" value="${sal.loan}" onchange="updateSalaryField('${staffId}', 'loan', this.value)" class="w-full glass-card text-white placeholder-white/50 px-2 py-1 rounded-xl focus:outline-none focus:ring-2 focus:ring-purple-400">
      </td>
      <td class="py-3 px-4 text-red-400">${sal.pending.toLocaleString()}</td>
      <td class="py-3 px-4">${sal.netSalary.toLocaleString()}</td>
      <td class="py-3 px-4">
        <span class="${sal.paymentStatus === 'Paid' ? 'bg-green-500/20 text-green-400' : 'bg-red-500/20 text-red-400'} px-2 py-1 rounded-full text-xs">${sal.paymentStatus}</span>
      </td>
      <td class="py-3 px-4">
        ${sal.paymentStatus === 'Unpaid' ? `<button onclick="showConfirmModal('${staffId}')" class="liquid-btn text-white px-3 py-1 rounded-lg font-semibold transition-all hover:scale-105"><i class="fas fa-check mr-2"></i>Mark Paid</button>` : ''}
      </td>
    `;
    tbody.appendChild(tr);
  });
}

// Update salary field and save to Firebase
async function updateSalaryField(staffId, field, value) {
  salaryData[staffId][field] = Number(value);
  const s = salaryData[staffId];
  s.netSalary = Math.round((s.baseSalary / s.totalDays) * s.presentDays + s.allowances - s.deductions - s.advance - s.loan);
  await db.ref(`staffSalaries/${staffId}/${currentMonthKey}`).set(salaryData[staffId]);
  populateSalaryTable();
}

// Show confirmation modal for marking as paid
function showConfirmModal(staffId) {
  currentStaffId = staffId;
  document.getElementById('modalTitle').textContent = 'Confirm Payment';
  document.getElementById('modalMessage').textContent = `Are you sure you want to mark the salary of ${staffData[staffId].fullName} for ${currentMonthKey} as Paid? This will also add an entry to the journal.`;
  document.getElementById('confirmModal').style.display = 'flex';
}

// Mark salary as Paid and update journal
async function markAsPaid(staffId) {
  const salary = salaryData[staffId];
  salary.paymentStatus = "Paid";
  salary.paymentDate = new Date().toISOString().split('T')[0];

  try {
    // Update salary status
    const salaryRef = db.ref(`staffSalaries/${staffId}/${currentMonthKey}`);
    await salaryRef.set(salary);

    // Add journal entry
    const journalEntry = {
      date: salary.paymentDate,
      type: 'Debit', // Expense for the school
      paymentMethod: 'Bank', // Matches Daily Book payment modes
      category: 'Teacher Salaries', // Matches Daily Book category
      amount: salary.netSalary,
      note: `Salary payment for ${staffData[staffId].fullName} - ${currentMonthKey}`,
      account: 'Bank', // Default account, can be adjusted
      ref: `SAL-${staffId}-${currentMonthKey}`,
      createdAt: Date.now(),
      serverAt: firebase.database.ServerValue.TIMESTAMP
    };
    const journalRef = db.ref('journal').push();
    const journalId = journalRef.key;
    await journalRef.set(journalEntry);

    // Update salary with journal transaction ID
    salary.transactionId = journalId;
    await salaryRef.set(salary);

    alert('Salary marked as Paid and added to journal!');
    generatePayslipPDF(staffId, salary, currentMonthKey);
    populateSalaryTable();
    loadHistory();
  } catch (error) {
    alert('Error marking salary as paid: ' + error.message);
  }
}

// Generate PDF Payslip
function generatePayslipPDF(staffId, salary, monthKey) {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  doc.setFontSize(16);
  doc.text("Staff Salary Payslip", 105, 20, null, null, "center");
  doc.setFontSize(12);
  doc.text(`Name: ${staffData[staffId].fullName}`, 20, 40);
  doc.text(`Role: ${staffData[staffId].role}`, 20, 50);
  doc.text(`Month: ${monthKey}`, 20, 60);
  doc.text(`Base Salary: ${salary.baseSalary.toLocaleString()}`, 20, 70);
  doc.text(`Allowances: ${salary.allowances.toLocaleString()}`, 20, 80);
  doc.text(`Deductions: ${salary.deductions.toLocaleString()}`, 20, 90);
  doc.text(`Advance: ${salary.advance.toLocaleString()}`, 20, 100);
  doc.text(`Loan: ${salary.loan.toLocaleString()}`, 20, 110);
  doc.text(`Present Days: ${salary.presentDays}/${salary.totalDays}`, 20, 120);
  doc.text(`Previous Pending: ${salary.pending.toLocaleString()}`, 20, 130);
  doc.text(`Net Salary: ${salary.netSalary.toLocaleString()}`, 20, 140);
  doc.text(`Payment Date: ${salary.paymentDate || '-'}`, 20, 150);
  doc.text(`Transaction ID: ${salary.transactionId || '-'}`, 20, 160);
  doc.save(`Payslip_${staffData[staffId].fullName}_${monthKey}.pdf`);
}

// Load Salary History
function loadHistory() {
  const historyTbody = document.querySelector('#historyTable tbody');
  historyTbody.innerHTML = '';
  db.ref('staffSalaries').once('value').then(snap => {
    const allSalaries = snap.val() || {};
    Object.keys(allSalaries).forEach(staffId => {
      const s = staffData[staffId];
      if (!s) return;
      Object.keys(allSalaries[staffId]).forEach(month => {
        const sal = allSalaries[staffId][month];
        const tr = document.createElement('tr');
        tr.className = 'border-b border-white/10 hover:bg-white/5';
        tr.innerHTML = `
          <td class="py-3 px-4">
            <div class="font-medium text-white">${s.fullName}</div>
            <div class="text-sm text-white/60">${s.email}</div>
          </td>
          <td class="py-3 px-4">
            <span class="px-2 py-1 rounded-full text-xs ${
              s.role === 'Teacher' ? 'bg-blue-500/20 text-blue-400' :
              s.role === 'Admin' ? 'bg-purple-500/20 text-purple-400' :
              s.role === 'Accountant' ? 'bg-green-500/20 text-green-400' :
              'bg-yellow-500/20 text-yellow-400'
            }">${s.role}</span>
          </td>
          <td class="py-3 px-4">${month}</td>
          <td class="py-3 px-4">${sal.netSalary.toLocaleString()}</td>
          <td class="py-3 px-4">
            <span class="${sal.paymentStatus === 'Paid' ? 'bg-green-500/20 text-green-400' : 'bg-red-500/20 text-red-400'} px-2 py-1 rounded-full text-xs">${sal.paymentStatus}</span>
          </td>
          <td class="py-3 px-4">${sal.paymentDate || '-'}</td>
        `;
        historyTbody.appendChild(tr);
      });
    });
  });
}

// Modal Handlers
document.getElementById('closeModal').addEventListener('click', () => {
  document.getElementById('confirmModal').style.display = 'none';
});

document.getElementById('cancelAction').addEventListener('click', () => {
  document.getElementById('confirmModal').style.display = 'none';
});

document.getElementById('confirmAction').addEventListener('click', () => {
  markAsPaid(currentStaffId);
  document.getElementById('confirmModal').style.display = 'none';
});

// Debounced search and filter
function debounce(func, wait) {
  let timeout;
  return function executedFunction(...args) {
    const later = () => {
      clearTimeout(timeout);
      func(...args);
    };
    clearTimeout(timeout);
    timeout = setTimeout(later, wait);
  };
}

const debouncedPopulateTable = debounce(populateSalaryTable, 300);
document.getElementById('searchStaffSalary').addEventListener('keyup', debouncedPopulateTable);
document.getElementById('searchStaffSalaryMobile').addEventListener('keyup', debouncedPopulateTable);
document.getElementById('filterRoleSalary').addEventListener('change', debouncedPopulateTable);
document.getElementById('salaryMonth').addEventListener('change', loadSalary);
document.getElementById('refreshSalary').addEventListener('click', () => {
  loadSalary();
  loadHistory();
});
</script>
{% endblock %}