{% extends "Admin-base.html" %}

{% block title %}Inventory Management - UEBS{% endblock %}

{% block content %}
<!-- Top Navbar -->
<div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 sm:mb-8 space-y-4 sm:space-y-0">
  <div class="mt-12 md:mt-0">
    <h2 class="text-2xl sm:text-3xl lg:text-4xl font-bold text-white animate__animated animate__fadeInLeft bg-gradient-to-r from-white to-gray-300 bg-clip-text text-transparent">Inventory Management</h2>
    <p class="text-white/70 mt-1 text-sm sm:text-base">Manage inventory items and track issuance/returns</p>
  </div>
  <div class="flex items-center space-x-2 sm:space-x-4 w-full sm:w-auto">
    <div class="hidden md:block relative flex-1 max-w-md">
      <input type="text" id="searchItem" placeholder="Search items..." class="w-full glass-card text-white placeholder-white/50 px-4 py-2 rounded-xl focus:outline-none focus:ring-2 focus:ring-purple-400 search-input">
      <button class="absolute right-3 top-2 text-white/70 hover:text-white">
        <i class="fas fa-search"></i>
      </button>
    </div>
    <button class="glass-card p-2 sm:p-3 rounded-xl text-white hover:bg-white/20 transition-all relative md:hidden" onclick="document.getElementById('searchItemMobile').focus()">
      <i class="fas fa-search text-sm sm:text-base"></i>
    </button>
  </div>
</div>

<!-- Mobile search bar -->
<div class="md:hidden mb-4">
  <div class="relative">
    <input type="text" id="searchItemMobile" placeholder="Search items..." class="w-full glass-card text-white placeholder-white/50 px-4 py-2 rounded-xl focus:outline-none focus:ring-2 focus:ring-purple-400 search-input">
    <button class="absolute right-3 top-2 text-white/70 hover:text-white">
      <i class="fas fa-search"></i>
    </button>
  </div>
</div>

<!-- Add/Edit Item -->
<div class="glass-card p-4 mb-6 rounded-2xl animate__animated animate__fadeInUp">
  <h3 class="text-xl sm:text-2xl font-semibold text-white mb-6 flex items-center">
    <i class="fas fa-plus-circle text-purple-400 mr-3"></i> Add / Edit Item
  </h3>
  <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
    <div>
      <label class="block text-white/80 mb-2">Item Name</label>
      <input type="text" id="itemName" class="w-full glass-card text-white placeholder-white/50 px-4 py-2 rounded-xl focus:outline-none focus:ring-2 focus:ring-purple-400" placeholder="e.g., Textbook">
    </div>
    <div>
      <label class="block text-white/80 mb-2">Category</label>
      <input type="text" id="itemCategory" class="w-full glass-card text-white placeholder-white/50 px-4 py-2 rounded-xl focus:outline-none focus:ring-2 focus:ring-purple-400" placeholder="e.g., Books">
    </div>
    <div>
      <label class="block text-white/80 mb-2">Quantity</label>
      <input type="number" id="itemQty" class="w-full glass-card text-white placeholder-white/50 px-4 py-2 rounded-xl focus:outline-none focus:ring-2 focus:ring-purple-400" placeholder="e.g., 100">
    </div>
    <div>
      <label class="block text-white/80 mb-2">Unit Price</label>
      <input type="number" id="itemPrice" step="0.01" class="w-full glass-card text-white placeholder-white/50 px-4 py-2 rounded-xl focus:outline-none focus:ring-2 focus:ring-purple-400" placeholder="e.g., 10.50">
    </div>
    <div>
      <label class="block text-white/80 mb-2">Supplier (Optional)</label>
      <input type="text" id="itemSupplier" class="w-full glass-card text-white placeholder-white/50 px-4 py-2 rounded-xl focus:outline-none focus:ring-2 focus:ring-purple-400" placeholder="e.g., ABC Supplies">
    </div>
    <div class="md:col-span-3">
      <label class="block text-white/80 mb-2">Description (Optional)</label>
      <textarea id="itemDesc" class="w-full glass-card text-white placeholder-white/50 px-4 py-2 rounded-xl focus:outline-none focus:ring-2 focus:ring-purple-400" placeholder="e.g., Mathematics textbooks for Class 10"></textarea>
    </div>
  </div>
  <div class="flex space-x-4 mt-6">
    <button id="addItemBtn" class="liquid-btn text-white px-6 py-3 rounded-xl font-semibold transition-all hover:scale-105">
      <i class="fas fa-plus mr-2"></i> Add Item
    </button>
  </div>
</div>

<!-- Inventory List -->
<div class="glass-card p-6 lg:p-8 rounded-2xl animate__animated animate__fadeInUp mb-6">
  <h3 class="text-xl sm:text-2xl font-semibold text-white mb-6 flex items-center">
    <i class="fas fa-list text-purple-400 mr-3"></i> Inventory
  </h3>
  <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
    <div>
      <label class="block text-white/80 mb-2">Category</label>
      <select id="filterCategory" class="w-full glass-card text-white placeholder-white/50 px-4 py-2 rounded-xl focus:outline-none focus:ring-2 focus:ring-purple-400">
        <option value="">All Categories</option>
      </select>
    </div>
  </div>
  <div class="overflow-x-auto">
    <table class="w-full text-white/80" id="inventoryTable">
      <thead>
        <tr class="border-b border-white/20">
          <th class="text-left py-3 px-4">#</th>
          <th class="text-left py-3 px-4">Name</th>
          <th class="text-left py-3 px-4">Category</th>
          <th class="text-left py-3 px-4">Quantity</th>
          <th class="text-left py-3 px-4">Unit Price</th>
          <th class="text-left py-3 px-4">Supplier</th>
          <th class="text-left py-3 px-4">Description</th>
          <th class="text-left py-3 px-4">Actions</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<!-- Issue/Return Item -->
<div class="glass-card p-6 lg:p-8 rounded-2xl animate__animated animate__fadeInUp mb-6">
  <h3 class="text-xl sm:text-2xl font-semibold text-white mb-6 flex items-center">
    <i class="fas fa-exchange-alt text-purple-400 mr-3"></i> Issue / Return Item
  </h3>
  <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
    <div>
      <label class="block text-white/80 mb-2">Select Item</label>
      <select id="selectItem" class="w-full glass-card text-white placeholder-white/50 px-4 py-2 rounded-xl focus:outline-none focus:ring-2 focus:ring-purple-400">
        <option value="">Select an item</option>
      </select>
    </div>
    <div>
      <label class="block text-white/80 mb-2">Action Type</label>
      <select id="actionType" class="w-full glass-card text-white placeholder-white/50 px-4 py-2 rounded-xl focus:outline-none focus:ring-2 focus:ring-purple-400">
        <option value="Issue">Issue</option>
        <option value="Return">Return</option>
      </select>
    </div>
    <div>
      <label class="block text-white/80 mb-2">Issued/Returned To</label>
      <input type="text" id="issuedTo" class="w-full glass-card text-white placeholder-white/50 px-4 py-2 rounded-xl focus:outline-none focus:ring-2 focus:ring-purple-400" placeholder="e.g., John Doe">
    </div>
    <div>
      <label class="block text-white/80 mb-2">Quantity</label>
      <input type="number" id="actionQty" class="w-full glass-card text-white placeholder-white/50 px-4 py-2 rounded-xl focus:outline-none focus:ring-2 focus:ring-purple-400" placeholder="e.g., 5">
    </div>
  </div>
  <div class="flex space-x-4 mt-6">
    <button id="saveActionBtn" class="liquid-btn text-white px-6 py-3 rounded-xl font-semibold transition-all hover:scale-105">
      <i class="fas fa-save mr-2"></i> Save
    </button>
  </div>
</div>

<!-- History Table -->
<div class="glass-card p-6 lg:p-8 rounded-2xl animate__animated animate__fadeInUp">
  <h3 class="text-xl sm:text-2xl font-semibold text-white mb-6 flex items-center">
    <i class="fas fa-history text-purple-400 mr-3"></i> History
  </h3>
  <div class="overflow-x-auto">
    <table class="w-full text-white/80" id="historyTable">
      <thead>
        <tr class="border-b border-white/20">
          <th class="text-left py-3 px-4">#</th>
          <th class="text-left py-3 px-4">Item Name</th>
          <th class="text-left py-3 px-4">Action</th>
          <th class="text-left py-3 px-4">Quantity</th>
          <th class="text-left py-3 px-4">Issued/Returned To</th>
          <th class="text-left py-3 px-4">Date</th>
          <th class="text-left py-3 px-4">Remaining Stock</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<!-- Confirmation Modal -->
<div class="modal fixed inset-0 bg-black/50 z-50 hidden justify-center items-center" id="confirmModal">
  <div class="glass-card p-6 lg:p-8 rounded-2xl w-full max-w-md">
    <div class="flex justify-between items-center mb-6">
      <h3 class="text-xl sm:text-2xl font-semibold text-white" id="modalTitle">Confirm Delete</h3>
      <button id="closeModal" class="text-white/70 hover:text-white text-2xl">&times;</button>
    </div>
    <p class="text-white/80 mb-6" id="modalMessage">Are you sure you want to delete this item? This will also delete associated history.</p>
    <div class="flex justify-end space-x-4">
      <button id="confirmAction" class="liquid-btn text-white px-6 py-3 rounded-xl font-semibold transition-all hover:scale-105">
        Confirm
      </button>
      <button id="cancelAction" class="glass-card text-white px-6 py-3 rounded-xl font-semibold transition-all hover:bg-white/20">
        Cancel
      </button>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/10.9.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.9.0/firebase-database-compat.js"></script>

<script>
// Initialize Firebase with your config
const firebaseConfig = {
  apiKey: "YOUR_API_KEY",
  authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
  databaseURL: "https://YOUR_PROJECT_ID.firebaseio.com",
  projectId: "YOUR_PROJECT_ID",
  storageBucket: "YOUR_PROJECT_ID.appspot.com",
  messagingSenderId: "YOUR_SENDER_ID",
  appId: "YOUR_APP_ID"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();

let items = {};
let history = {};
let currentEditItemId = null;

// Load Items and History
db.ref('inventory').on('value', snap => {
  items = snap.val() || {};
  populateInventoryTable();
  populateItemSelect();
  populateCategoryFilter();
});

db.ref('inventoryHistory').on('value', snap => {
  history = snap.val() || {};
  populateHistoryTable();
});

// Add/Edit Item
document.getElementById('addItemBtn').addEventListener('click', () => {
  const btn = document.getElementById('addItemBtn');
  btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Saving...';
  btn.disabled = true;

  const item = {
    name: document.getElementById('itemName').value.trim(),
    category: document.getElementById('itemCategory').value.trim(),
    quantity: parseInt(document.getElementById('itemQty').value) || 0,
    price: parseFloat(document.getElementById('itemPrice').value) || 0,
    supplier: document.getElementById('itemSupplier').value.trim(),
    desc: document.getElementById('itemDesc').value.trim()
  };

  if (!item.name || !item.category || !item.quantity || !item.price) {
    alert("Please fill all required fields (Name, Category, Quantity, Unit Price)");
    btn.innerHTML = '<i class="fas fa-plus mr-2"></i> ' + (currentEditItemId ? 'Update Item' : 'Add Item');
    btn.disabled = false;
    return;
  }

  const ref = currentEditItemId ? db.ref('inventory/' + currentEditItemId) : db.ref('inventory').push();
  ref.set(item).then(() => {
    alert(currentEditItemId ? 'Item updated!' : 'Item added!');
    clearItemForm();
    currentEditItemId = null;
    btn.innerHTML = '<i class="fas fa-plus mr-2"></i> Add Item';
    btn.disabled = false;
  });
});

function clearItemForm() {
  document.getElementById('itemName').value = '';
  document.getElementById('itemCategory').value = '';
  document.getElementById('itemQty').value = '';
  document.getElementById('itemPrice').value = '';
  document.getElementById('itemSupplier').value = '';
  document.getElementById('itemDesc').value = '';
}

// Populate Inventory Table
function populateInventoryTable() {
  const tbody = document.querySelector('#inventoryTable tbody');
  tbody.innerHTML = '';
  const search = document.getElementById('searchItem').value.toLowerCase() || 
                 document.getElementById('searchItemMobile').value.toLowerCase();
  const filterCat = document.getElementById('filterCategory').value;

  Object.keys(items).forEach((id, idx) => {
    const i = items[id];
    if (search && !i.name.toLowerCase().includes(search)) return;
    if (filterCat && i.category !== filterCat) return;
    const tr = document.createElement('tr');
    tr.className = 'border-b border-white/10 hover:bg-white/5';
    tr.innerHTML = `
      <td class="py-3 px-4">${idx + 1}</td>
      <td class="py-3 px-4">${i.name}</td>
      <td class="py-3 px-4">${i.category}</td>
      <td class="py-3 px-4">${i.quantity}</td>
      <td class="py-3 px-4">${i.price.toFixed(2)}</td>
      <td class="py-3 px-4">${i.supplier || '-'}</td>
      <td class="py-3 px-4">${i.desc || '-'}</td>
      <td class="py-3 px-4">
        <div class="flex space-x-2">
          <button onclick="editItem('${id}')" class="glass-card px-3 py-1 rounded-lg text-yellow-400 hover:bg-yellow-400/20">
            <i class="fas fa-edit"></i>
          </button>
          <button onclick="deleteItem('${id}')" class="glass-card px-3 py-1 rounded-lg text-red-400 hover:bg-red-400/20">
            <i class="fas fa-trash"></i>
          </button>
        </div>
      </td>
    `;
    tbody.appendChild(tr);
  });
}

// Edit Item
function editItem(id) {
  const i = items[id];
  currentEditItemId = id;
  document.getElementById('itemName').value = i.name;
  document.getElementById('itemCategory').value = i.category;
  document.getElementById('itemQty').value = i.quantity;
  document.getElementById('itemPrice').value = i.price;
  document.getElementById('itemSupplier').value = i.supplier || '';
  document.getElementById('itemDesc').value = i.desc || '';
  document.getElementById('addItemBtn').innerHTML = '<i class="fas fa-edit mr-2"></i> Update Item';
}

// Delete Item
function deleteItem(id) {
  const modal = document.getElementById('confirmModal');
  const confirmBtn = document.getElementById('confirmAction');
  const cancelBtn = document.getElementById('cancelAction');
  const closeBtn = document.getElementById('closeModal');
  modal.classList.remove('hidden');

  confirmBtn.onclick = () => {
    db.ref('inventory/' + id).remove();
    // Optionally, remove related history entries
    Object.keys(history).forEach(hid => {
      if (history[hid].itemName === items[id].name) {
        db.ref('inventoryHistory/' + hid).remove();
      }
    });
    modal.classList.add('hidden');
  };
  cancelBtn.onclick = () => modal.classList.add('hidden');
  closeBtn.onclick = () => modal.classList.add('hidden');
}

// Populate Category Filter
function populateCategoryFilter() {
  const categories = new Set();
  Object.values(items).forEach(i => {
    if (i.category) categories.add(i.category);
  });
  const sel = document.getElementById('filterCategory');
  sel.innerHTML = '<option value="">All Categories</option>' + 
                  Array.from(categories).map(c => `<option value="${c}">${c}</option>`).join('');
}

// Populate Item Select for Issue/Return
function populateItemSelect() {
  const sel = document.getElementById('selectItem');
  sel.innerHTML = '<option value="">Select an item</option>' + 
                  Object.keys(items).map(id => `<option value="${id}">${items[id].name}</option>`).join('');
}

// Save Issue/Return Action
document.getElementById('saveActionBtn').addEventListener('click', () => {
  const btn = document.getElementById('saveActionBtn');
  btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Saving...';
  btn.disabled = true;

  const itemId = document.getElementById('selectItem').value;
  const action = document.getElementById('actionType').value;
  const qty = parseInt(document.getElementById('actionQty').value) || 0;
  const issuedTo = document.getElementById('issuedTo').value.trim();

  if (!itemId || !qty || !issuedTo) {
    alert('Please fill all fields (Item, Quantity, Issued/Returned To)');
    btn.innerHTML = '<i class="fas fa-save mr-2"></i> Save';
    btn.disabled = false;
    return;
  }

  const item = items[itemId];
  let newQty = item.quantity;
  if (action === 'Issue') {
    if (qty > item.quantity) {
      alert('Not enough stock');
      btn.innerHTML = '<i class="fas fa-save mr-2"></i> Save';
      btn.disabled = false;
      return;
    }
    newQty -= qty;
  } else {
    newQty += qty;
  }

  db.ref('inventory/' + itemId + '/quantity').set(newQty).then(() => {
    const histKey = db.ref('inventoryHistory').push().key;
    db.ref('inventoryHistory/' + histKey).set({
      itemName: item.name,
      action: action,
      quantity: qty,
      issuedTo: issuedTo,
      date: new Date().toLocaleString('en-US', { timeZone: 'Asia/Kathmandu' }),
      remaining: newQty
    }).then(() => {
      alert('Action saved!');
      document.getElementById('actionQty').value = '';
      document.getElementById('issuedTo').value = '';
      btn.innerHTML = '<i class="fas fa-save mr-2"></i> Save';
      btn.disabled = false;
    });
  });
});

// Populate History Table
function populateHistoryTable() {
  const tbody = document.querySelector('#historyTable tbody');
  tbody.innerHTML = '';
  Object.keys(history).forEach((id, idx) => {
    const h = history[id];
    const tr = document.createElement('tr');
    tr.className = 'border-b border-white/10';
    tr.innerHTML = `
      <td class="py-3 px-4">${idx + 1}</td>
      <td class="py-3 px-4">${h.itemName}</td>
      <td class="py-3 px-4">${h.action}</td>
      <td class="py-3 px-4">${h.quantity}</td>
      <td class="py-3 px-4">${h.issuedTo}</td>
      <td class="py-3 px-4">${h.date}</td>
      <td class="py-3 px-4">${h.remaining}</td>
    `;
    tbody.appendChild(tr);
  });
}

// Debounced search
function debounce(func, wait) {
  let timeout;
  return function executedFunction(...args) {
    const later = () => {
      clearTimeout(timeout);
      func(...args);
    };
    clearTimeout(timeout);
    timeout = setTimeout(later, wait);
  };
}

const debouncedPopulateTable = debounce(populateInventoryTable, 300);
document.getElementById('searchItem').addEventListener('keyup', debouncedPopulateTable);
document.getElementById('searchItemMobile').addEventListener('keyup', debouncedPopulateTable);
document.getElementById('filterCategory').addEventListener('change', populateInventoryTable);

// Initial load
populateInventoryTable();
populateItemSelect();
populateCategoryFilter();
populateHistoryTable();
</script>
{% endblock %}