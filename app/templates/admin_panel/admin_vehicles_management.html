{% extends "Admin-base.html" %}

{% block title %}Vehicle Management - School Management System{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8 sm:py-12">
  <!-- Header -->
  <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 sm:mb-8 space-y-4 sm:space-y-0">
    <div class="mt-12 md:mt-0">
      <h2 class="text-2xl sm:text-3xl lg:text-4xl font-bold text-white animate__animated animate__fadeInLeft bg-gradient-to-r from-white to-gray-300 bg-clip-text text-transparent">
        Vehicle Management
      </h2>
      <p class="text-white/70 mt-1 text-sm sm:text-base">Manage School Transportation</p>
    </div>
    <div class="flex items-center space-x-2 sm:space-x-4 w-full sm:w-auto">
      <!-- Search bar for larger screens -->
      <div class="hidden md:block relative flex-1 max-w-md">
        <input type="text" id="searchInput" placeholder="Search vehicles, drivers..." class="w-full glass-card text-white placeholder-white/50 px-4 py-2 rounded-xl focus:outline-none focus:ring-2 focus:ring-purple-400" aria-label="Search vehicles or drivers">
        <button class="absolute right-3 top-2 text-white/70 hover:text-white" aria-label="Search">
          <i class="fas fa-search"></i>
        </button>
      </div>
      <button class="glass-card p-2 sm:p-3 rounded-xl text-white hover:bg-white/20 transition-all relative md:hidden" aria-label="Toggle search">
        <i class="fas fa-search text-sm sm:text-base"></i>
      </button>
      <button class="glass-card p-2 sm:p-3 rounded-xl text-white hover:bg-white/20 transition-all relative" aria-label="Notifications">
        <i class="fas fa-bell text-sm sm:text-base"></i>
        <span class="absolute -top-1 -right-1 w-2 h-2 sm:w-3 sm:h-3 bg-red-500 rounded-full"></span>
      </button>
      <button class="liquid-btn text-white px-3 sm:px-6 py-2 sm:py-3 rounded-xl font-semibold transition-all hover:scale-105 text-sm sm:text-base">
        Profile
      </button>
    </div>
  </div>

  <!-- Mobile search bar -->
  <div class="md:hidden mb-4">
    <div class="relative">
      <input type="text" id="searchInputMobile" placeholder="Search vehicles, drivers..." class="w-full glass-card text-white placeholder-white/50 px-4 py-2 rounded-xl focus:outline-none focus:ring-2 focus:ring-purple-400" aria-label="Search vehicles or drivers">
      <button class="absolute right-3 top-2 text-white/70 hover:text-white" aria-label="Search">
        <i class="fas fa-search"></i>
      </button>
    </div>
  </div>

  <!-- Vehicle Input Form -->
  <div class="glass-card p-4 sm:p-6 lg:p-8 rounded-2xl animate__animated animate__fadeInUp mb-6 sm:mb-8">
    <h3 class="text-xl sm:text-2xl font-semibold text-white mb-4 sm:mb-6">Add New Vehicle</h3>
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
      <input type="text" id="vehicleNumber" placeholder="Vehicle Number" class="glass-card text-white placeholder-white/50 px-4 py-2 rounded-xl focus:outline-none focus:ring-2 focus:ring-purple-400" aria-label="Vehicle Number">
      <input type="text" id="vehicleType" placeholder="Vehicle Type (e.g., Bus, Van)" class="glass-card text-white placeholder-white/50 px-4 py-2 rounded-xl focus:outline-none focus:ring-2 focus:ring-purple-400" aria-label="Vehicle Type">
      <input type="text" id="driverName" placeholder="Driver Name" class="glass-card text-white placeholder-white/50 px-4 py-2 rounded-xl focus:outline-none focus:ring-2 focus:ring-purple-400" aria-label="Driver Name">
      <input type="text" id="driverNumber" placeholder="Driver Phone Number" class="glass-card text-white placeholder-white/50 px-4 py-2 rounded-xl focus:outline-none focus:ring-2 focus:ring-purple-400" aria-label="Driver Phone Number">
      <input type="number" id="driverAge" placeholder="Driver Age" class="glass-card text-white placeholder-white/50 px-4 py-2 rounded-xl focus:outline-none focus:ring-2 focus:ring-purple-400" aria-label="Driver Age" min="18">
      <input type="text" id="notes" placeholder="Notes (e.g., Route, Capacity)" class="glass-card text-white placeholder-white/50 px-4 py-2 rounded-xl focus:outline-none focus:ring-2 focus:ring-purple-400" aria-label="Additional Notes">
    </div>
    <button onclick="addVehicle()" class="liquid-btn text-white px-6 py-3 rounded-xl font-semibold transition-all hover:scale-105 mt-4" aria-label="Add Vehicle">
      <i class="fas fa-plus-circle mr-2"></i>Add Vehicle
    </button>
  </div>

  <!-- Vehicle Table -->
  <div class="glass-card p-4 sm:p-6 lg:p-8 rounded-2xl animate__animated animate__fadeInUp">
    <h3 class="text-xl sm:text-2xl font-semibold text-white mb-4 sm:mb-6">Vehicle List</h3>
    <div class="overflow-x-auto">
      <table class="w-full border-collapse">
        <thead>
          <tr class="bg-white/10">
            <th class="p-3 sm:p-4 text-white/80 text-left text-sm sm:text-base">Vehicle Number</th>
            <th class="p-3 sm:p-4 text-white/80 text-left text-sm sm:text-base">Type</th>
            <th class="p-3 sm:p-4 text-white/80 text-left text-sm sm:text-base">Driver</th>
            <th class="p-3 sm:p-4 text-white/80 text-left text-sm sm:text-base">Driver Number</th>
            <th class="p-3 sm:p-4 text-white/80 text-left text-sm sm:text-base">Driver Age</th>
            <th class="p-3 sm:p-4 text-white/80 text-left text-sm sm:text-base">Notes</th>
            <th class="p-3 sm:p-4 text-white/80 text-left text-sm sm:text-base">Action</th>
          </tr>
        </thead>
        <tbody id="vehicleTable"></tbody>
      </table>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/10.9.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.9.0/firebase-database-compat.js"></script>

<script>
// Initialize Firebase
const firebaseConfig = {
  apiKey: "AIzaSyC7cG8KemxvH2VveDO6DnIkYUpIl2exesU",
  authDomain: "uebs-school.firebaseapp.com",
  projectId: "uebs-school",
  storageBucket: "uebs-school.firebasestorage.app",
  messagingSenderId: "740325293639",
  appId: "1:740325293639:web:9c505c9a48dd8ccc55fb62",
  measurementId: "G-T7YEBMNHBH"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// Add Vehicle
function addVehicle() {
  const vehicleNumber = document.getElementById("vehicleNumber").value.trim();
  const vehicleType = document.getElementById("vehicleType").value.trim();
  const driverName = document.getElementById("driverName").value.trim();
  const driverNumber = document.getElementById("driverNumber").value.trim();
  const driverAge = parseInt(document.getElementById("driverAge").value.trim());
  const notes = document.getElementById("notes").value.trim();
  
  if (vehicleNumber && vehicleType && driverName && driverNumber && driverAge) {
    if (driverAge < 18) {
      alert("Driver age must be 18 or older.");
      return;
    }
    const newKey = db.ref("vehicles").push().key;
    db.ref("vehicles/" + newKey).set({
      vehicleNumber,
      vehicleType,
      driverName,
      driverNumber,
      driverAge,
      notes,
      createdAt: firebase.database.ServerValue.TIMESTAMP
    }).then(() => {
      document.getElementById("vehicleNumber").value = '';
      document.getElementById("vehicleType").value = '';
      document.getElementById("driverName").value = '';
      document.getElementById("driverNumber").value = '';
      document.getElementById("driverAge").value = '';
      document.getElementById("notes").value = '';
    }).catch(error => {
      console.error("Error adding vehicle:", error);
      alert("Failed to add vehicle. Please try again.");
    });
  } else {
    alert("Please fill in all required fields (Vehicle Number, Type, Driver Name, Driver Number, Driver Age).");
  }
}

// Display Vehicles
db.ref("vehicles").on("value", snapshot => {
  const data = snapshot.val();
  const table = document.getElementById("vehicleTable");
  table.innerHTML = '';
  if (data) {
    for (let key in data) {
      const row = `
        <tr class="hover:bg-white/10 transition-all">
          <td class="p-3 sm:p-4 text-white text-sm sm:text-base">${data[key].vehicleNumber}</td>
          <td class="p-3 sm:p-4 text-white text-sm sm:text-base">${data[key].vehicleType}</td>
          <td class="p-3 sm:p-4 text-white text-sm sm:text-base">${data[key].driverName}</td>
          <td class="p-3 sm:p-4 text-white text-sm sm:text-base">${data[key].driverNumber || '-'}</td>
          <td class="p-3 sm:p-4 text-white text-sm sm:text-base">${data[key].driverAge || '-'}</td>
          <td class="p-3 sm:p-4 text-white text-sm sm:text-base">${data[key].notes || '-'}</td>
          <td class="p-3 sm:p-4">
            <button onclick="deleteVehicle('${key}')" class="glass-card p-2 rounded-xl text-red-400 hover:bg-red-400/20 transition-all" aria-label="Delete vehicle ${data[key].vehicleNumber}">
              <i class="fas fa-trash-alt"></i> Delete
            </button>
          </td>
        </tr>`;
      table.innerHTML += row;
    }
  } else {
    table.innerHTML = `<tr><td colspan="7" class="p-3 sm:p-4 text-white/70 text-center">No vehicles found.</td></tr>`;
  }
});

// Delete Vehicle
function deleteVehicle(key) {
  if (confirm("Are you sure you want to delete this vehicle?")) {
    db.ref("vehicles/" + key).remove().catch(error => {
      console.error("Error deleting vehicle:", error);
      alert("Failed to delete vehicle. Please try again.");
    });
  }
}

// Search Functionality
function setupSearch() {
  const searchInputs = [document.getElementById("searchInput"), document.getElementById("searchInputMobile")];
  searchInputs.forEach(input => {
    if (input) {
      input.addEventListener("input", () => {
        const query = input.value.toLowerCase();
        const rows = document.querySelectorAll("#vehicleTable tr");
        rows.forEach(row => {
          const cells = row.querySelectorAll("td");
          if (cells.length > 0) {
            const vehicleNumber = cells[0].textContent.toLowerCase();
            const vehicleType = cells[1].textContent.toLowerCase();
            const driverName = cells[2].textContent.toLowerCase();
            const driverNumber = cells[3].textContent.toLowerCase();
            const driverAge = cells[4].textContent.toLowerCase();
            const notes = cells[5].textContent.toLowerCase();
            row.style.display = (
              vehicleNumber.includes(query) ||
              vehicleType.includes(query) ||
              driverName.includes(query) ||
              driverNumber.includes(query) ||
              driverAge.includes(query) ||
              notes.includes(query)
            ) ? "" : "none";
          }
        });
      });
    }
  });
}

document.addEventListener("DOMContentLoaded", setupSearch);

console.log('Vehicle Management page loaded');
</script>
{% endblock %}